rule apt_RU_Turla_Carbon_Dropper : apt {

meta:
	author = "sisoma2"
	date = "26/06/2020"
	desc = "Detects the Turla Carbon Dropper"
	md5 = "	a6efd027b121347201a3de769389e6dd"
	version = "0.1"
	
strings:
	$strgrp1_1 = "viIta" wide ascii
	$strgrp1_2 = "S-1-16-12288" wide ascii
	$strgrp1_3 = "S:(ML;;NW;;;S-1-16-0)" wide ascii
	$strgrp1_4 = "A;OICIID;GA" wide ascii
	
	
	$strgrp2_1 = "Virtual Private Network Routing Service" wide ascii
	$strgrp2_2 = "Health Key and Certificate Management Service" wide ascii
	$strgrp2_3 = "System Restore Service" wide ascii
	$strgrp2_4 = "Alerter" wide ascii
	
	$code1 = { C6 44 ?? ?? C1 C6 44 ?? ?? B4 C6 44 ?? ?? A5 C6 44 ?? ?? 85 C6 44 ?? ?? 56 C6 44 ?? ?? 24 C6 44 ?? ?? 42 C6 44 ?? ?? C6 C6 44 ?? ?? 18 C6 44 ?? ?? 44 C6 44 ?? ?? 37 C6 44 ?? ?? 9C C6 44 ?? ?? 6B C6 44 ?? ?? B5 C6 44 ?? ?? 97 C6 44 ?? ?? E3 }
	$code2 = { B9 00 20 00 00 FF 15 [4] 48 89 [1-6] 48 8D [1-6] 48 89 [1-6] 41 B9 00 20 00 00 4C 8B [1-6] 33 D2 48 8B [1-6] FF 15 [4] 85 C0 75 2B FF 15 }
	
condition:
	(uint16(0) == 0x5A4D) and (filesize < 1MB) and 1 of ($code*) and any of ($strgrp1_*) and any of ($strgrp2_*)
   
}